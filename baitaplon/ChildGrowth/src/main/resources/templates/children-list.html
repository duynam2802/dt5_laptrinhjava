<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="Danh sách trẻ em trong hệ thống ChildGrowth">
    <meta name="author" content="ChildGrowth Team">
    <title>ChildGrowth - Danh sách trẻ</title>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <link href="/css/sb-admin-2.min.css" rel="stylesheet">

    <style>
        .child-card {
            border: 1px solid #4e73df;
            border-left: 5px solid #4e73df;
            border-radius: 10px;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
    
        .child-card:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 20px rgba(78, 115, 223, 0.3);
        }
    
        .bg-boy {
            background-color: #d4edda; /* xanh lá nhạt */
        }
    
        .bg-girl {
            background-color: #f8d7da; /* hồng nhạt */
        }

        .loading-spinner {
            display: none;
            text-align: center;
            padding: 20px;
        }
    </style>
</head>
<body id="page-top">
<div id="wrapper">
    <!-- Sidebar -->
    <ul class="navbar-nav bg-gradient-primary sidebar sidebar-dark accordion" id="accordionSidebar">
        <!-- Sidebar - Brand -->
        <a class="sidebar-brand d-flex align-items-center justify-content-center" href="/index">
            <div class="sidebar-brand-icon">
                <i class="fas fa-baby"></i>
            </div>
            <div class="sidebar-brand-text mx-3">ChildGrowth</div>
        </a>

        <!-- Divider -->
        <hr class="sidebar-divider my-0">

        <!-- Nav Item - Dashboard -->
        <li class="nav-item active">
            <a class="nav-link" href="/index">
                <i class="fas fa-fw fa-home"></i>
                <span>Trang chủ</span></a>
        </li>

        <!-- Divider -->
        <hr class="sidebar-divider">

        <!-- Heading -->
        <div class="sidebar-heading">
            Quản lý trẻ em
        </div>

        <!-- Nav Item - Quản lý trẻ em -->
        <li class="nav-item">
            <a class="nav-link d-flex align-items-center" data-bs-toggle="collapse" href="#childrenMenu"
               role="button" aria-expanded="false" aria-controls="childrenMenu">
                <i class="fas fa-fw fa-child me-2"></i>
                <span>Quản lý trẻ em</span>
            </a>
            <div id="childrenMenu" class="collapse">
                <div class="bg-white py-2 collapse-inner rounded">
                    <a class="collapse-item" href="/users/child/children-list">Danh sách trẻ</a>
                    <a class="collapse-item" href="/users/child/add-child">Thêm trẻ mới</a>
                    <a class="collapse-item" href="/growth-charts">Biểu đồ phát triển</a>
                    <a class="collapse-item" href="/health-alerts">Cảnh báo sức khỏe</a>
                </div>
            </div>
        </li>

        <!-- Divider -->
        <hr class="sidebar-divider">

        <!-- Heading -->
        <div class="sidebar-heading">
            Tư vấn
        </div>

        <!-- Nav Item - Tư vấn bác sĩ -->
        <li class="nav-item">
            <a class="nav-link d-flex align-items-center" data-bs-toggle="collapse" href="#helpMenu"
               role="button" aria-expanded="false" aria-controls="helpMenu">
                <i class="fas fa-fw fa-stethoscope me-2"></i>
                <span>Tư vấn</span>
            </a>
            <div id="helpMenu" class="collapse">
                <div class="bg-white py-2 collapse-inner rounded">
                    <a class="collapse-item" href="/new-consult">Tư vấn bác sĩ</a>
                    <a class="collapse-item" href="/support-request">Yêu cầu hỗ trợ</a>
                </div>
            </div>
        </li>

        <li class="nav-item">
            <a class="nav-link" href="/blog">
                <i class="fas fa-edit"></i>
                <span>Blog</span></a>
        </li>

        <!-- Divider -->
        <hr class="sidebar-divider">

        <!-- Heading -->
        <div class="sidebar-heading">
            Tài khoản
        </div>

        <!-- Nav Item - Tài khoản -->
        <li class="nav-item">
            <a class="nav-link" href="/users/profile/update">
                <i class="fas fa-fw fa-user"></i>
                <span>Thông tin tài khoản</span></a>
        </li>

        <!-- Divider -->
        <hr class="sidebar-divider d-none d-md-block">

        <!-- Sidebar Toggler (Sidebar) -->
        <div class="text-center d-none d-md-inline">
            <button class="rounded-circle border-0" id="sidebarToggle"></button>
        </div>
    </ul>
    <!-- End of Sidebar -->

    <div id="content-wrapper" class="d-flex flex-column">
        <div id="content">
            <!-- Topbar -->
            <nav class="navbar navbar-expand navbar-light bg-white topbar mb-4 static-top shadow">
                <button id="sidebarToggleTop" class="btn btn-link d-md-none rounded-circle mr-3">
                    <i class="fa fa-bars"></i>
                </button>
            </nav>
            <!-- End of Topbar -->

            <div class="container-fluid">
                <!-- Thông báo lỗi -->
                <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
                    <span th:text="${error}"></span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>

                <!-- Tiêu đề trang -->
                <div class="d-sm-flex align-items-center justify-content-between mb-4">
                    <h1 class="h3 mb-0 text-gray-800">Danh sách trẻ</h1>
                    <a href="/users/child/add-child" class="btn btn-primary btn-icon-split">
                        <span class="icon text-white-50">
                            <i class="fas fa-plus"></i>
                        </span>
                        <span class="text">Thêm trẻ mới</span>
                    </a>
                </div>

                <!-- Loading Spinner -->
                <div id="loading-spinner" class="loading-spinner">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Đang tải...</span>
                    </div>
                </div>

                <!-- Danh sách trẻ -->
                <div id="children-list" class="row"></div>

                <!-- Trạng thái rỗng -->
                <div id="no-children" class="alert alert-info text-center" style="display:none;">
                    Hiện tại chưa có trẻ nào trong danh sách. Vui lòng thêm trẻ mới.
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="sticky-footer bg-white">
            <div class="container my-auto">
                <div class="copyright text-center my-auto">
                    <span>Copyright © ChildGrowth - VP</span>
                </div>
            </div>
        </footer>
    </div>
</div>

<!-- Modal Chi tiết trẻ -->
<div class="modal fade" id="childDetailModal" tabindex="-1" aria-labelledby="childDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="childDetailModalLabel">Thông tin chi tiết</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-4 text-center">
                        <img id="detail-avatar" src="" alt="Avatar" class="rounded-circle shadow mb-3" style="width: 150px; height: 150px; object-fit: cover;">
                    </div>
                    <div class="col-md-8">
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Họ tên:</strong> <span id="detail-name"></span></p>
                                <p><strong>Biệt danh:</strong> <span id="detail-nickname"></span></p>
                                <p><strong>Ngày sinh:</strong> <span id="detail-dob"></span></p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Giới tính:</strong> <span id="detail-gender"></span></p>
                                <p><strong>Tuổi:</strong> <span id="detail-age"></span></p>
                                <p><strong>Cân nặng:</strong> <span id="detail-weight"></span> kg</p>
                                <p><strong>Chiều cao:</strong> <span id="detail-height"></span> cm</p>
                            </div>
                        </div>
                        <div class="mt-3">
                            <h6 class="text-primary">Lịch sử sức khỏe</h6>
                            <ul id="health-history" class="list-group"></ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Cập nhật chỉ số -->
<div class="modal fade" id="updateGrowthModal" tabindex="-1" aria-labelledby="updateGrowthModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="updateGrowthModalLabel">Cập nhật chỉ số</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="updateGrowthForm">
                <div class="modal-body">
                    <input type="hidden" id="growth-child-id">
                    <div class="mb-3">
                        <label for="update-date" class="form-label">Ngày cập nhật</label>
                        <input type="date" class="form-control" id="update-date" value="">
                    </div>
                    <div class="mb-3">
                        <label for="update-weight" class="form-label">Cân nặng (kg) <span class="text-danger">*</span></label>
                        <input type="number" step="0.1" class="form-control" id="update-weight" required>
                    </div>
                    <div class="mb-3">
                        <label for="update-height" class="form-label">Chiều cao (cm) <span class="text-danger">*</span></label>
                        <input type="number" step="0.1" class="form-control" id="update-height" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="submit" class="btn btn-primary">Cập nhật</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Xác nhận Xóa -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="confirmDeleteModalLabel">Xác nhận xóa</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Bạn có chắc chắn muốn xóa trẻ này? Hành động này không thể hoàn tác!</p>
                <input type="hidden" id="delete-child-id">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Xóa</button>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap 5 JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<!-- Core JavaScript -->
<script src="/vendor/jquery/jquery.min.js"></script>
<script src="/js/sb-admin-2.min.js"></script>
<!-- Custom JavaScript -->
<script>
    // Hàm tiện ích để hiển thị thông báo
    function showNotification(message, type = 'success') {
        const alert = document.createElement('div');
        alert.className = `alert alert-${type} alert-dismissible fade show`;
        alert.role = 'alert';
        alert.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        document.querySelector('.container-fluid').prepend(alert);
        setTimeout(() => alert.remove(), 5000);
    }

    // Hàm mã hóa HTML để ngăn XSS
    function escapeHTML(str) {
        if (!str) return '';
        return str
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }

    // Hàm tạo thẻ card trẻ em
    function createChildCard(child) {
        const avatarSrc = child.chiTiet.gender === 'FEMALE' ? '/img/nu.jpg' : '/img/nam.jpg';
        const card = document.createElement('div');
        card.className = `col-md-4 mb-4`;
        card.innerHTML = `
            <div class="card shadow h-100 child-card ${child.chiTiet.gender === 'FEMALE' ? 'bg-girl' : 'bg-boy'}">
                <div class="card-body d-flex align-items-center">
                    <div class="me-3">
                        <img src="${avatarSrc}" alt="Avatar" class="rounded-circle shadow" style="width: 80px; height: 80px; object-fit: cover;">
                    </div>
                    <div class="flex-grow-1">
                        <h5 class="card-title mb-2">${escapeHTML(child.hoTen)}</h5>
                        <p class="mb-1"><strong>Biệt danh:</strong> ${escapeHTML(child.BietDanh || 'Không có')}</p>
                        <p class="mb-1"><strong>Tuổi:</strong> ${child.tuoi}</p>
                        <p class="mb-0"><strong>Giới tính:</strong> ${child.chiTiet.gender === 'FEMALE' ? 'Nữ' : 'Nam'}</p>
                    </div>
                    <div class="ms-3 d-flex flex-column">
                        <button class="btn btn-info btn-sm mb-2 text-white" data-child-id="${child.id}">Chi tiết trẻ</button>
                        <button class="btn btn-primary btn-sm mb-2" data-child-id="${child.id}" data-weight="${child.chiTiet.weight || ''}" data-height="${child.chiTiet.height || ''}">
                            <i class="fas fa-edit me-1"></i> Cập nhật chỉ số
                        </button>
                        <button class="btn btn-danger btn-sm" data-child-id="${child.id}" data-child-name="${escapeHTML(child.hoTen)}">
                            <i class="fas fa-trash-alt me-1"></i> Xóa
                        </button>
                    </div>
                </div>
            </div>
        `;

        card.querySelector('.btn-info').addEventListener('click', () => fetchChildDetails(child.id));
        card.querySelector('.btn-primary').addEventListener('click', () => showGrowthForm(child.id, child.chiTiet.weight, child.chiTiet.height));
        card.querySelector('.btn-danger').addEventListener('click', () => showDeleteConfirm(child.id, child.hoTen));

        return card;
    }

    // Hàm hiển thị spinner loading
    function showLoading(show) {
        const spinner = document.getElementById('loading-spinner');
        spinner.style.display = show ? 'block' : 'none';
    }

    // Hàm tải danh sách trẻ
    async function loadChildren() {
        showLoading(true);
        try {
            const response = await fetch('/users/child/api/children-list');
            if (!response.ok) throw new Error('Không thể tải danh sách trẻ');
            const data = await response.json();
            const childrenList = data.danhSachCon;
            const childrenContainer = document.getElementById('children-list');
            const noChildrenMessage = document.getElementById('no-children');

            childrenContainer.innerHTML = '';
            if (childrenList.length === 0) {
                noChildrenMessage.style.display = 'block';
            } else {
                noChildrenMessage.style.display = 'none';
                childrenList.forEach(child => childrenContainer.appendChild(createChildCard(child)));
            }
        } catch (error) {
            console.error('Lỗi:', error);
            showNotification('Lỗi khi tải danh sách trẻ: ' + error.message, 'danger');
        } finally {
            showLoading(false);
        }
    }

    // Hàm lấy chi tiết trẻ
    async function fetchChildDetails(childId) {
        try {
            const response = await fetch(`/api/children/${childId}`, {
                headers: { 'Authorization': `Bearer ${localStorage.getItem('token') || ''}` }
            });
            if (!response.ok) throw new Error('Không thể lấy thông tin trẻ');
            const child = await response.json();

            document.getElementById('detail-avatar').src = child.chiTiet.gender === 'FEMALE' ? '/img/nu.jpg' : '/img/nam.jpg';
            document.getElementById('detail-name').textContent = escapeHTML(child.hoTen);
            document.getElementById('detail-nickname').textContent = escapeHTML(child.BietDanh || 'Không có');
            document.getElementById('detail-dob').textContent = child.chiTiet.dateOfBirth || 'Chưa cập nhật';
            document.getElementById('detail-gender').textContent = child.chiTiet.gender === 'FEMALE' ? 'Nữ' : 'Nam';
            document.getElementById('detail-age').textContent = child.tuoi;
            document.getElementById('detail-weight').textContent = child.chiTiet.weight || 'Chưa đo';
            document.getElementById('detail-height').textContent = child.chiTiet.height || 'Chưa đo';

            const healthList = document.getElementById('health-history');
            healthList.innerHTML = '';
            if (child.healthRecords && child.healthRecords.length > 0) {
                child.healthRecords.forEach(record => {
                    const li = document.createElement('li');
                    li.className = 'list-group-item';
                    li.innerHTML = `
                        <strong>${escapeHTML(record.date)}</strong>: ${escapeHTML(record.description)}
                        <span class="badge bg-${record.severity === 'HIGH' ? 'danger' : 'warning'} float-end">
                            ${record.severity === 'HIGH' ? 'Nghiêm trọng' : 'Bình thường'}
                        </span>
                    `;
                    healthList.appendChild(li);
                });
            } else {
                healthList.innerHTML = '<li class="list-group-item text-muted">Chưa có dữ liệu lịch sử sức khỏe</li>';
            }

            const modal = new bootstrap.Modal(document.getElementById('childDetailModal'));
            modal.show();
        } catch (error) {
            console.error('Lỗi:', error);
            showNotification('Lỗi khi lấy thông tin trẻ: ' + error.message, 'danger');
        }
    }

    // Hàm mở modal cập nhật chỉ số
    function showGrowthForm(childId, currentWeight, currentHeight) {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('growth-child-id').value = childId;
        document.getElementById('update-date').value = today;
        document.getElementById('update-weight').value = currentWeight || '';
        document.getElementById('update-height').value = currentHeight || '';

        const modal = new bootstrap.Modal(document.getElementById('updateGrowthModal'));
        modal.show();
    }

    // Xử lý submit cập nhật chỉ số
    document.getElementById('updateGrowthForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const childId = document.getElementById('growth-child-id').value;
        const token = localStorage.getItem('token');
        if (!token) {
            showNotification('Vui lòng đăng nhập lại', 'danger');
            return;
        }

        const weight = parseFloat(document.getElementById('update-weight').value);
        const height = parseFloat(document.getElementById('update-height').value);
        if (isNaN(weight) || weight <= 0 || isNaN(height) || height <= 0) {
            showNotification('Cân nặng và chiều cao phải là số dương', 'danger');
            return;
        }

        const payload = {
            canNang: weight,
            chieuCao: height,
            thoiDiem: document.getElementById('update-date').value || new Date().toISOString().split('T')[0]
        };

        try {
            const response = await fetch(`/api/children/update-growth/${childId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(payload)
            });

            const result = await response.json();
            if (!response.ok) throw new Error(result.message || 'Cập nhật thất bại');

            showNotification('Cập nhật chỉ số thành công!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('updateGrowthModal')).hide();
            loadChildren();
        } catch (error) {
            console.error('Lỗi:', error);
            showNotification(`Lỗi: ${error.message}`, 'danger');
        }
    });

    // Hàm mở modal xác nhận xóa
    function showDeleteConfirm(childId, childName) {
        document.getElementById('delete-child-id').value = childId;
        document.getElementById('confirmDeleteModalLabel').innerText = `Xóa ${escapeHTML(childName || 'trẻ này')}`;

        const modal = new bootstrap.Modal(document.getElementById('confirmDeleteModal'));
        modal.show();
    }

    // Xử lý xóa trẻ
    document.getElementById('confirmDeleteBtn').addEventListener('click', async function() {
        const childId = document.getElementById('delete-child-id').value;
        const token = localStorage.getItem('token');
        if (!token) {
            showNotification('Vui lòng đăng nhập lại', 'danger');
            return;
        }

        try {
            const response = await fetch(`/api/children/delete/${childId}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.message || 'Xóa thất bại');
            }

            showNotification('Đã xóa trẻ thành công!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('confirmDeleteModal')).hide();
            loadChildren();
        } catch (error) {
            console.error('Lỗi:', error);
            showNotification(`Lỗi: ${error.message}`, 'danger');
        }
    });

    // Tải danh sách trẻ khi trang được tải
    document.addEventListener('DOMContentLoaded', loadChildren);
</script>
</body>
</html>